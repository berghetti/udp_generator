
hosts: !import hosts.yml::hosts

programs:
    set_kernel_params:
        start: >-
            pushd udp_generator;
            ./misc/set_boot_params.sh &&
            sudo update-grub &&
            sudo reboot
        checked_rtn: null

    prepare_clients:
        start: >-
            rm -rf udp_generator;
            git clone -b afp_changes https://github.com/berghetti/udp_generator.git;
            pushd udp_generator;
            ./install_requirements.sh;
            ./install_dpdk.sh ||
            echo 0 &&
            ./setup.sh &&
            make

    set_clients_ip:
        start: >-
            pushd udp_generator &&
            ./misc/set_ip.sh {host.ip} {server_ip}

    generic:
        start: >-
            {0.args.cmd}

    prepare_afp:
        start: >-
            rm -rf afp;
            git clone -b dev https://github.com/berghetti/afp.git;
            pushd afp;
            ./install_prerequisites.sh &&
            make dpdk || echo 0 &&
            make &&
            make setup

    prepare_psp:
        start: >-
            rm -rf psp;
            git clone https://github.com/berghetti/psp.git;
            pushd psp;
            git submodule update --init submodules/dpdk;
            git submodule update --init submodules/fake_work;
            git submodule update --init submodules/rocksdb;
            ./install_prerequisites.sh &&
            PSP_DIR=~/psp ./scripts/setup/base_setup.sh


    afp_start:
        start: >-
            pushd afp &&
            sudo src/build/helloworld -n 2 -l 0,2,4,6,8,10,12,14,16,18,20,22,24,26,28 -a 18:00.1
            #stop: sudo kill -2 {pid}
        stop: sudo pkill -2 helloworld
        log:
            dir: afp_server
            out: stdout.txt
            err: stderr.txt

    psp_start:
        start: >-
            pushd psp &&
            sudo ./build/src/c++/apps/app/psp-app --cfg ./configs/base_psp_cfg.yml --label test
            #stop: sudo kill -9 {pid}
        stop: sudo pkill -2 psp-app
        log:
            dir: psp_server
            out: stdout.txt
            err: stderr.txt

    client_start:
        start: >-
            pushd udp_generator &&
            ./run/run.sh {0.args.basedir}/{host.name}/ {0.args.policy} {0.args.rate} {0.args.wk} $({host.rand} + {0.args.rand})$ {0.args.test}

